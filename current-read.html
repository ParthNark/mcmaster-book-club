<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Read ‚Äì McMaster Book Club</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://openlibrary.org">
    <link rel="preconnect" href="https://covers.openlibrary.org">
    <link rel="preconnect" href="https://script.google.com">
    <link rel="preconnect" href="https://script.googleusercontent.com">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="js/api.js"></script>
    <script src="js/openlibrary.js"></script>
</head>
<body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Navigation Bar (consistent with index.html) -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html"><img src="images/logo.png" alt="McMaster Book Club logo" class="nav-logo-img"> McMaster Book Club</a>
            </div>
            <button class="hamburger" id="hamburger" aria-label="Toggle navigation" aria-expanded="false">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu" id="nav-menu">
                <li class="nav-item"><a href="index.html#home" class="nav-link">Home</a></li>
                <li class="nav-item"><a href="index.html#about" class="nav-link">About</a></li>
                <li class="nav-item"><a href="current-read.html" class="nav-link nav-link-active">Current Read</a></li>
                <li class="nav-item"><a href="meetings-events.html" class="nav-link">Meetings & Events</a></li>
                <li class="nav-item"><a href="index.html#join" class="nav-link nav-link-cta">Join Us</a></li>
            </ul>
        </div>
    </nav>

    <main id="main-content">
        <!-- Page Hero -->
        <section class="page-hero">
            <div class="container">
                <h1>üìö Current Reads</h1>
                <p>What we're reading this month ‚Äî and what's coming next.</p>
            </div>
        </section>

        <!-- Current Books (dynamically rendered) -->
        <section class="section cr-book-section">
            <div class="container">
                <p id="cr-loading" class="cr-loading-msg">Loading current reads‚Ä¶</p>
                <div id="cr-books-container"></div>
                <p id="cr-error" class="cr-error-msg" style="display:none;">Book details loading failed ‚Äî please check back.</p>
            </div>
        </section>

        <!-- Vote for Next Month's Book -->
        <section class="section cr-vote-section">
            <div class="container">
                <h2>
                    <span class="section-icon">üó≥Ô∏è</span>
                    Stay Tuned: Vote for Next Month's Book
                </h2>
                <div class="cr-vote-content">
                    <p>
                        Every month, members get to vote on the next read! When voting opens, 
                        click the button below to cast your vote via our Google Form.
                    </p>
                    <button id="vote-btn" class="btn btn-primary btn-large" disabled>
                        Voting opens soon
                    </button>
                    <p class="cr-vote-hint">The button will activate once voting is open.</p>
                </div>
            </div>
        </section>

        <!-- Past Reads -->
        <section class="section cr-past-section">
            <div class="container">
                <h2>
                    <span class="section-icon">üìñ</span>
                    Past Reads
                </h2>
                <div id="past-reads-container">
                    <div class="cr-past-grid">
                        <div class="skeleton-card"><div class="skeleton-line skeleton-title"></div><div class="skeleton-line skeleton-author"></div><div class="skeleton-line skeleton-blurb"></div><div class="skeleton-line skeleton-blurb short"></div></div>
                        <div class="skeleton-card"><div class="skeleton-line skeleton-title"></div><div class="skeleton-line skeleton-author"></div><div class="skeleton-line skeleton-blurb"></div><div class="skeleton-line skeleton-blurb short"></div></div>
                        <div class="skeleton-card"><div class="skeleton-line skeleton-title"></div><div class="skeleton-line skeleton-author"></div><div class="skeleton-line skeleton-blurb"></div><div class="skeleton-line skeleton-blurb short"></div></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer (consistent with index.html) -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>McMaster Book Club</h4>
                <p>Building community through the love of reading.</p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="index.html#home">Home</a></li>
                    <li><a href="index.html#about">About</a></li>
                    <li><a href="current-read.html">Current Read</a></li>
                    <li><a href="meetings-events.html">Meetings & Events</a></li>
                    <li><a href="index.html#join">Join Us</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Connect</h4>
                <div class="footer-social">
                    <a href="https://www.instagram.com/mcmasterbooks/" target="_blank" rel="noopener" aria-label="Instagram" class="footer-social-link">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <rect width="24" height="24" fill="none"/>
                            <rect x="2" y="2" width="20" height="20" rx="4.18" ry="4.18" fill="none" stroke="currentColor" stroke-width="2"/>
                            <circle cx="12" cy="12" r="3.6" fill="none" stroke="currentColor" stroke-width="2"/>
                            <circle cx="18.5" cy="5.5" r="1.5" fill="currentColor"/>
                        </svg>
                    </a>
                    <a href="https://linktr.ee/mcmasterbooks" target="_blank" rel="noopener" aria-label="Linktree" class="footer-social-link">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.953 15.066l-.038-4.18 4.058-.002v13.12h.076V10.882l4.058.002-.038 4.18 4.354-4.1-1.476-1.58-2.762 2.608.038-5.238h3.4L12 0 4.553 6.754h3.4l.038 5.238-2.762-2.608-1.476 1.58 4.2 4.102z" fill="currentColor"/>
                        </svg>
                    </a>
                    <a href="#" aria-label="Discord" class="footer-social-link">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20.317 4.3671c-1.8345-.8954-3.970-.4383-3.970-.4383l-.195.234c2.3825.7234 3.5175 1.7622 3.5175 1.7622-1.5-.7372-2.9906-1.0972-4.4131-1.2237-.9035-.1117-1.7885-.0835-2.6059.0619 0 0 .137-.1618.4147-.3953-1.6365-.247-3.0992.1584-3.0992.1584s1.1246 1.0369 3.5042 1.7397v-.01c.4725.5648.9451 1.1295 1.3175 1.7622.6234 1.1293.9935 2.4627.9935 3.7961 0 0-.5589 1.1947-2.1768 1.5921 0 0 .1302.1618.4147.1618 1.3175 0 2.1768-.9452 2.1768-.9452.1302 1.2564-.3897 2.511-1.1246 3.4294-.6234.7371-1.5588 1.2565-2.5233 1.3441.5878.4665 1.3175.7919 2.1768.8238.8592.0318 1.7593-.1319 2.5233-.4665.7641-.3346 1.5281-.8874 2.0765-1.55-.3897 2.511-2.6059 4.3671-5.2118 4.3671-1.3175 0-2.5233-.3345-3.5175-1.0369.2914-.1938.5878-.3884.8813-.5829 1.5-.9451 2.8537-2.3758 3.6227-4.0328.7641-1.657 1.0285-3.4933.7641-5.2936-.2645-1.8003-.7641-3.494-1.8345-4.9575z" fill="currentColor"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 McMaster Book Club. All rights reserved. Made with <span class="heart">‚ù§Ô∏è</span> for book lovers.</p>
        </div>
    </footer>

    <script>
        // ‚îÄ‚îÄ‚îÄ Mobile menu toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        var hamburger = document.getElementById('hamburger');
        var navMenu = document.getElementById('nav-menu');

        hamburger.addEventListener('click', function () {
            navMenu.classList.toggle('active');
            hamburger.setAttribute('aria-expanded',
                hamburger.getAttribute('aria-expanded') === 'false' ? 'true' : 'false'
            );
        });

        document.querySelectorAll('.nav-link').forEach(function (link) {
            link.addEventListener('click', function () {
                navMenu.classList.remove('active');
                hamburger.setAttribute('aria-expanded', 'false');
            });
        });

        document.addEventListener('click', function (e) {
            if (!e.target.closest('.nav-container')) {
                navMenu.classList.remove('active');
                hamburger.setAttribute('aria-expanded', 'false');
            }
        });

        /** Escape HTML entities to prevent XSS */
        function escapeHtml(str) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // ‚îÄ‚îÄ‚îÄ Load TWO current books + Open Library data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        (async function () {
            var loadingEl   = document.getElementById('cr-loading');
            var containerEl = document.getElementById('cr-books-container');
            var errorEl     = document.getElementById('cr-error');

            /**
             * Fetch config from Google Sheets API first.
             * getCurrent() returns normalized { books, voting_open, vote_form_url }.
             */
            async function loadConfig() {
                if (typeof getCurrent === 'function' &&
                    typeof API_BASE !== 'undefined' &&
                    API_BASE !== 'PASTE_WEB_APP_URL_HERE') {
                    try {
                        var apiData = await getCurrent();
                        if (apiData && !apiData.error) return apiData;
                    } catch (e) {
                        console.warn('API fetch failed, falling back to local JSON:', e);
                    }
                }
                var res = await fetch('data/current.json');
                if (!res.ok) throw new Error('Could not load config from API or local file');
                return res.json();
            }

            try {
                // 1. Load config
                var config = await loadConfig();

                // books is always an array (normalized by api.js _normalizeCurrent)
                var books = config.books || [];
                if (books.length === 0) throw new Error('No books in response');

                // 2. Fetch Open Library data for each book in parallel
                var olPromises = books.map(function (b) { return fetchBookFromOpenLibrary(b); });
                var olResults  = await Promise.all(olPromises);

                // 3. Hide loading
                if (loadingEl) loadingEl.style.display = 'none';

                // 4. Render a full book card for each book
                var html = '';
                for (var i = 0; i < books.length; i++) {
                    var bk   = books[i];
                    var book = olResults[i];
                    var bookId = bk.id || ('book' + (i + 1));

                    var title = escapeHtml(book.title || bk.title || 'TBA');
                    var authorsText = (book.authors && book.authors.length > 0)
                        ? 'by ' + escapeHtml(book.authors.join(', '))
                        : (bk.author ? 'by ' + escapeHtml(bk.author) : '');
                    var coverSrc = book.coverUrl || 'images/current-book-cover.png';
                    var summaryText = escapeHtml(book.description || bk.custom_summary || '');

                    // Tags
                    var tagsHtml = '';
                    var tagsList = (bk.tags && bk.tags.length > 0) ? bk.tags : (book.subjects || []);
                    tagsList.forEach(function (tag) {
                        tagsHtml += '<span class="cr-tag">' + escapeHtml(tag) + '</span>';
                    });

                    // Meeting info
                    var meetingHtml = '<li><strong>When:</strong> ' + escapeHtml(bk.meeting_time || 'TBA') + '</li>'
                        + '<li><strong>Where:</strong> ' + escapeHtml(bk.meeting_location || 'TBA') + '</li>';
                    if (bk.meeting_notes) {
                        meetingHtml += '<li><strong>Notes:</strong> ' + escapeHtml(bk.meeting_notes) + '</li>';
                    }

                    // Discussion prompts
                    var promptsHtml = '';
                    if (bk.discussion_prompts && bk.discussion_prompts.length > 0) {
                        bk.discussion_prompts.forEach(function (q) {
                            promptsHtml += '<li>' + escapeHtml(q) + '</li>';
                        });
                    }

                    // Goodreads button
                    var grBtnHtml = '';
                    if (bk.goodreads_url && bk.goodreads_url.trim()) {
                        grBtnHtml = '<a class="btn btn-secondary btn-goodreads" href="' + escapeHtml(bk.goodreads_url) + '" target="_blank" rel="noopener">‚≠ê View Ratings on Goodreads</a>';
                    }

                    html += '<div class="cr-book-card" id="' + bookId + '">'
                        + '<div class="cr-book-cover">'
                        +   '<img src="' + coverSrc + '" alt="Cover of ' + title + '" onerror="this.onerror=null;this.src=\'images/current-book-cover.png\';">'
                        + '</div>'
                        + '<div class="cr-book-info">'
                        +   '<h2 class="cr-book-title">' + title + '</h2>'
                        +   '<p class="cr-book-author">' + authorsText + '</p>'
                        +   '<div class="cr-tags">' + tagsHtml + '</div>'
                        +   '<p class="cr-book-summary">' + summaryText + '</p>'
                        +   '<div class="cr-meeting-info"><h3>üìÖ Meeting Info</h3><ul>' + meetingHtml + '</ul></div>'
                        +   (promptsHtml ? '<div class="cr-discussion"><h3>üí¨ Discussion Prompts</h3><ol>' + promptsHtml + '</ol></div>' : '')
                        +   grBtnHtml
                        + '</div>'
                        + '</div>';
                }

                containerEl.innerHTML = html;

                // Scroll to anchored book if URL has #book1 or #book2
                if (window.location.hash) {
                    var target = document.getElementById(window.location.hash.substring(1));
                    if (target) {
                        setTimeout(function () { target.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
                    }
                }

                // 5. Vote button (global settings)
                var voteBtn = document.getElementById('vote-btn');
                if (config.voting_open && config.vote_form_url && config.vote_form_url.trim() !== '') {
                    voteBtn.disabled = false;
                    voteBtn.textContent = 'Vote for Next Month';
                    voteBtn.addEventListener('click', function () {
                        window.open(config.vote_form_url.trim(), '_blank');
                    });
                } else {
                    voteBtn.disabled = true;
                    voteBtn.textContent = 'Voting opens soon';
                }

                // 6. Load past reads
                loadPastReads();

            } catch (err) {
                console.error('Current-read page load error:', err);
                if (loadingEl) loadingEl.style.display = 'none';
                if (errorEl)   errorEl.style.display = 'block';
            }
        })();

        /**
         * Fetch past reads from Google Sheets API and render them dynamically.
         * Shows skeleton loading ‚Üí real cards on success, error state on failure.
         */
        async function loadPastReads() {
            var container = document.getElementById('past-reads-container');
            if (!container) return;

            try {
                if (typeof getPast !== 'function' ||
                    typeof API_BASE === 'undefined' ||
                    API_BASE === 'PASTE_WEB_APP_URL_HERE') {
                    throw new Error('API not configured');
                }

                var pastBooks = await getPast();
                if (!Array.isArray(pastBooks) || pastBooks.length === 0) {
                    throw new Error('No past reads returned');
                }

                // Build grid of real cards
                var gridHtml = '<div class="cr-past-grid">';
                pastBooks.forEach(function (book) {
                    gridHtml += '<article class="cr-past-card">';
                    gridHtml += '<h3>' + escapeHtml(book.title || 'Untitled') + '</h3>';
                    if (book.author) {
                        gridHtml += '<p class="cr-past-author">by ' + escapeHtml(book.author) + '</p>';
                    }
                    if (book.month) {
                        gridHtml += '<p class="cr-past-month">' + escapeHtml(book.month) + '</p>';
                    }
                    if (book.short_blurb) {
                        gridHtml += '<p class="cr-past-blurb">' + escapeHtml(book.short_blurb) + '</p>';
                    }
                    gridHtml += '</article>';
                });
                gridHtml += '</div>';

                container.innerHTML = gridHtml;

            } catch (e) {
                console.warn('Could not load past reads:', e);
                container.innerHTML = '<div class="error-state">Unable to load past reads right now.</div>';
            }
        }
    </script>
</body>
</html>
